<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Slackloop QC tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        
        #map {
            height: 96vh;
            
        }
        .highlight {
            color: red;
            font-weight: bold;
        }
        .custom-popup {
            max-height: 150px; /* Set the max height for the popup */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .legend {
            background-color: white;
            padding: 10px;
            line-height: 18px;
            color: #333;
            opacity: 0.7;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .legend .circle {
            border-radius: 50%; /* Make the shape round */
        }
    </style>
</head>
<body>
    <!--<h1>Upload GeoJSON Files to Display Points on Map</h1>-->
    <label for="fileInputId">Original Slackloop (geojson)</label>
    <input type="file" id="geojsonInput1" accept=".geojson">
    <label for="fileInputId">Plan Slackloop (geojson)</label>
    <input type="file" id="geojsonInput2" accept=".geojson">
    <a href="Splicingtool.html">Splicing tool</a>
    <!--<input type="file" id="geojsonInput3" accept=".geojson"> --> <!-- Added third GeoJSON input -->
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map with scroll wheel zoom enabled and enhanced zoom options
        var map = L.map('map', {
            maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180)), // Ensure scroll wheel zoom is enabled
            minZoom: 2, // Adjust the zoom delta to control how much zoom changes per scroll event
        }).setView([0, 0], 2); // Start with world view

        // Add a tile layer (basemap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '@ Develop by JGN',
            maxZoom: 99
        }).addTo(map);

        // Helper function to calculate distance between two latlng points in meters
        function calculateDistance(latlng1, latlng2) {
            return map.distance(latlng1, latlng2);
        }

        var geojsonData1 = null; // Data from the first GeoJSON
        var geojsonData2 = null; // Data from the second GeoJSON
        //var geojsonData3 = null; // Data from the third GeoJSON

        var geojsonLayer1 = null; // Layer for the first GeoJSON
        //var geojsonLayer3 = null;

        function processGeoJSON(fileInputId, callback) {
            var fileInput = document.getElementById(fileInputId);
            fileInput.addEventListener('change', function(event) {
                var file = event.target.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var geojsonData = JSON.parse(e.target.result);
                    
                    if (fileInputId === 'geojsonInput1') {
                        geojsonData1 = geojsonData;
                        if (geojsonData2) {
                            updateMapWithCounts();
                        }
                        // Zoom to the location after uploading the first input
                        updateMapWithCounts();
                    } else if(fileInputId === 'geojsonInput2') {
                        geojsonData2 = geojsonData;
                        if (geojsonData1) {
                            updateMapWithCounts();
                        }
                    } /*else if (fileInputId === 'geojsonInput3') {
                        geojsonData3 = geojsonData;
                        showThirdGeoJSON();
                    }*/

                    // Invoke callback to handle the GeoJSON data if needed
                    if (callback) callback(geojsonData);
                };
                reader.readAsText(file);
            });
        }

        function updateMapWithCounts() {
    var coordCounts1 = {};
    //var coordCounts2 = {};
    //var length50Count = 0;
    //var length25Count = 0;

    // Count occurrences of each coordinate pair for the first GeoJSON
    geojsonData1.features.forEach(function(feature) {
        var coords = feature.geometry.coordinates.join(',');
        //var length = feature.properties.Length||'N/A';
        coordCounts1[coords] = (coordCounts1[coords] || 0) + 1;
        /*if (length === "50") length50Count++;
        if (length === "25") length50Count++;*/
    });

    // Count occurrences of each coordinate pair for the second GeoJSON
    /*geojsonData2.features.forEach(function(feature) {
        var coords = feature.geometry.coordinates.join(',');
        coordCounts2[coords] = (coordCounts2[coords] || 0) + 1;
    });*/

    // Clear previous layer
    if (geojsonLayer1) map.removeLayer(geojsonLayer1);

    // Add the first GeoJSON layer to the map with counts
    geojsonLayer1 = L.geoJSON(geojsonData1, {
    pointToLayer: function (feature, latlng) {
        var countWithinRadius = 0;
        var coords = feature.geometry.coordinates.join(',');

        // Determine the radius based on countSameCoords
        var radius = (coordCounts1[coords] > 1) ? 9.144 : 4.572; // 30 feet ≈ 9.144 meters, 10 feet ≈ 3.048 meters

        // Count how many points from the second GeoJSON are within the specified radius
        geojsonData2.features.forEach(function(otherFeature) {
            var otherLatLng = L.latLng(otherFeature.geometry.coordinates[1], otherFeature.geometry.coordinates[0]);
            if (calculateDistance(latlng, otherLatLng) <= radius) {
                countWithinRadius++;
            }
        });

        var countSameCoords = coordCounts1[coords] || 0;

        // Determine marker color based on the count comparison
        var markerColor;
        var outlineColor = "blue";

        if (countWithinRadius > countSameCoords) {
            markerColor = "yellow"; // Yellow
        } else if (countWithinRadius === countSameCoords) {
            markerColor = "#a3f307"; // Fluorescent green
        } else {
            markerColor = "red"; // Red
        }

        var marker = L.circleMarker(latlng, {
            radius: 8,
            fillColor: markerColor,
            color: outlineColor,
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        });

        // Collect properties from the second GeoJSON features within the specified radius
        var popupContent = "Inserted slack count: " + (countWithinRadius > countSameCoords ? "<span class='highlight'>" + countWithinRadius + "</span>" : countWithinRadius);
        popupContent += "<br>Original slack count: " + countSameCoords + "<br>";

        var length25Count = 0;
        var length50Count = 0;
        var totalLength25Count = 0;
        var totalLength50Count = 0;

        if (countSameCoords >= 2) {
            var lengths = [];
            geojsonData1.features.forEach(function(f) {
                var fCoords = f.geometry.coordinates.join(',');
                if (fCoords === coords) {
                    var length = f.properties.Length || 'N/A';
                    if (length === 25) length25Count++;
                    if (length === 50) length50Count++;
                }
            });
        } else {
            var length = feature.properties.Length || 'N/A';
            if (length === 25) length25Count++;
            if (length === 50) length50Count++;
        }

        var parentVetroIdCounts = {};
        var hasDuplicate = false;

        geojsonData2.features.forEach(function(otherFeature) {
            var otherLatLng = L.latLng(otherFeature.geometry.coordinates[1], otherFeature.geometry.coordinates[0]);
            if (calculateDistance(latlng, otherLatLng) <= radius) {
                var parentVetroId = otherFeature.properties.parent_vetro_id || 'N/A';
                var length2 = otherFeature.properties.Length || 'N/A';

                if (length2 === 25) totalLength25Count++;
                if (length2 === 50) totalLength50Count++;

                if (!parentVetroIdCounts[parentVetroId]) {
                    parentVetroIdCounts[parentVetroId] = 0;
                }
                parentVetroIdCounts[parentVetroId]++;

                if (parentVetroIdCounts[parentVetroId] > 1) {
                    hasDuplicate = true;
                }

                if (totalLength25Count > length25Count) {
                    hasmore25 = true;
                }
                if (totalLength50Count > length50Count) {
                    hasmore50 = true;
                }

                var coordinatesLink = "https://app.vetro.io/fibermap/map#25/" + otherFeature.geometry.coordinates[1] + "/" + otherFeature.geometry.coordinates[0];
                var linkClass = (parentVetroIdCounts[parentVetroId] > 1) ? "highlight" : "";

                var coordinatesStyle = parentVetroIdCounts[parentVetroId] > 1 ? "<span class='highlight'>" : "";
                var coordinatesEndStyle = parentVetroIdCounts[parentVetroId] > 1 ? "</span>" : "";

                popupContent += "<br>parent_vetro_id: " + (parentVetroIdCounts[parentVetroId] > 1 ? "<span class='highlight'>" + parentVetroId + "</span>" : parentVetroId);
                popupContent += "<br>Length: " + length2;
                popupContent += "<br>Coordinates: " + coordinatesStyle + "[" + otherFeature.geometry.coordinates.join(', ') + "]" + coordinatesEndStyle;
                popupContent += "<br><a class='" + linkClass + "' href='" + coordinatesLink + "' target='_blank'>View Location</a><br>";
            }
        });

        popupContent += "<br><strong>Total Inserted Length 25:</strong> " + (totalLength25Count > length25Count ? "<span class='highlight'>" + totalLength25Count + "</span>" : totalLength25Count);
        popupContent += "<br>Total Original Length 25: " + length25Count + "<br>";
        popupContent += "<br><strong>Total Inserted Length 50:</strong> " + (totalLength50Count > length50Count ? "<span class='highlight'>" + totalLength50Count + "</span>" : totalLength50Count);
        popupContent += "<br>Total Original Length 50: " + length50Count;

        if (hasDuplicate) {
            marker.setStyle({
                fillColor: "blue", // Blue
                color: outlineColor
            });
        } else if (length25Count === totalLength25Count && length50Count === totalLength50Count && countWithinRadius === countSameCoords) {
            marker.setStyle({
                fillColor: "#a3f307", // Purple
                color: outlineColor
            });
        } else if ((totalLength25Count > length25Count || totalLength50Count > length50Count) && countWithinRadius === countSameCoords) {
            marker.setStyle({
                fillColor: "yellow", // yellow
                color: outlineColor
            });
        }

        marker.bindPopup("<div class='custom-popup'>" + popupContent + "</div>");
        return marker;
    }
}).addTo(map);


    // Fit map bounds to include only the points from the first GeoJSON
    if (geojsonData1.features.length > 0) {
        var bounds = L.featureGroup([geojsonLayer1]).getBounds();
        map.fitBounds(bounds);
    }
}


        function showThirdGeoJSON() {
            if (geojsonLayer3) map.removeLayer(geojsonLayer3);

            geojsonLayer3 = L.geoJSON(geojsonData3, {
                style: function (feature) {
                    return {
                        color: "green",
                        weight: 2,
                        opacity: 1,
                        zIndex: 0 
                    };
                }
            }).addTo(map);

            
                var bounds = L.featureGroup([geojsonLayer3]).getBounds();
                map.fitBounds(bounds);
            
        }

        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<i class="circle" style="background: #a3f307"></i> Slackloop Pass<p>';
            div.innerHTML += '<i class="circle" style="background: yellow"></i>Incorrect Slackloop Length<p>';
            div.innerHTML += '<i class="circle" style="background: red"></i> Missing Slackloop<p>';
            div.innerHTML += '<i class="circle" style="background: blue"></i> Duplicate Slackloop';
            return div;
        };

        legend.addTo(map);

        // Process both GeoJSON inputs
        //processGeoJSON('geojsonInput3');
        processGeoJSON('geojsonInput1');
        processGeoJSON('geojsonInput2');
        
        
    </script>
</body>
</html>
